<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Domain Campaign Check</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 18px; max-width: 900px; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 14px; margin: 12px 0; }
    label { display:block; margin-top: 10px; font-weight: 600; }
    input { width: 100%; padding: 8px 10px; margin-top: 6px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { color:#666; }
    button { padding: 10px 12px; margin-top: 12px; cursor:pointer; }
    code { background:#f6f6f6; padding: 2px 5px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2 style="margin:0">Domain Campaign Check</h2>
  <div class="muted">This app automatically checks ALL active RedTrack campaigns (filtered to those with spend/revenue in the selected window) and sends Telegram alerts for failures.</div>
  <div class="muted">UTC now: {{ now.isoformat() }}</div>

  <div class="card">
    <h3 style="margin-top:0">Schedule & window</h3>
    <form method="post" action="/config">
      <label>Schedule mode</label>
      <input name="schedule_mode" value="{{ cfg.schedule_mode }}" />
      <div class="muted">Use <code>daily_at</code> (recommended) or <code>interval</code>.</div>

      <label>Run at (HH:MM) (TIMEZONE)</label>
      <input name="run_at_hhmm" value="{{ cfg.run_at_hhmm }}" placeholder="17:00" />
      <div class="muted">Example: 17:00 = 5pm IST.</div>

      <label>Run every (minutes) (used only if schedule_mode=interval)</label>
      <input name="interval_minutes" type="number" min="1" value="{{ cfg.interval_minutes }}" />
      <div class="muted">Example: 1440 = once per day.</div>

      <label>Lookback days (used when date_from/date_to are empty)</label>
      <input name="days_lookback" type="number" min="1" value="{{ cfg.days_lookback }}" />

      <div class="row">
        <div>
          <label>Date from (YYYY-MM-DD) optional</label>
          <input name="date_from" value="{{ cfg.date_from or '' }}" placeholder="2026-02-01" />
        </div>
        <div>
          <label>Date to (YYYY-MM-DD) optional</label>
          <input name="date_to" value="{{ cfg.date_to or '' }}" placeholder="2026-02-13" />
        </div>
      </div>
      <div class="muted">If both dates are set, the checker uses that exact window. Otherwise it uses last N days.</div>

      <label>Alert on first failure</label>
      <input name="alert_on_first_failure" value="{{ 'true' if cfg.alert_on_first_failure else 'false' }}" />
      <div class="muted">Keep <code>false</code> to reduce false alarms (retries happen first).</div>

      <button type="submit">Save settings</button>
    </form>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Run now</h3>
    <form method="post" action="/run">
      <button type="submit">Run check now</button>
    </form>
    {% if last_run %}
      <div class="muted" style="margin-top:10px">Last manual run: {{ last_run.time }} — {{ last_run.summary }}</div>
    {% endif %}
  </div>

  <div class="card">
    <h3 style="margin-top:0">Latest scheduled/manual run (cached)</h3>
    {% if latest %}
      <div class="muted">type: {{ latest['kind'] }} | ts: {{ latest['ts'] }} | checked: {{ latest['total_checked'] }} | failing: {{ latest['failing'] }}</div>
      <h4>Failing campaigns</h4>
      {% if failing_campaigns and failing_campaigns|length > 0 %}
        <ul>
          {% for it in failing_campaigns %}
            {% set c = it['campaign'] %}
            <li>
              <b>{{ c.get('title') or c.get('id') }}</b> ({{ c.get('id') }})
              {% if c.get('domain_name') %} — {{ c.get('domain_name') }}{% endif %}
              {% if c.get('trackback_url') %}<div class="muted">{{ c.get('trackback_url') }}</div>{% endif %}
              <div class="muted">
                {% for ch in it['failed'][:8] %}
                  {{ ch.get('kind') }}: {{ ch.get('failure_type') }} {{ ch.get('message') }}<br/>
                {% endfor %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">No failing campaigns in latest run.</div>
      {% endif %}
    {% else %}
      <div class="muted">No cached runs yet.</div>
    {% endif %}
  </div>

  <div class="card">
    <h3 style="margin-top:0">Notes</h3>
    <ul>
      <li>No database is used. Settings + cached run results are stored in local JSON files on disk. (On Render, attach a persistent disk if you want them to survive redeploys.)</li>
      <li>The checker always iterates through all <b>active campaigns</b> from RedTrack.</li>
    </ul>
  </div>
</body>
</html>
